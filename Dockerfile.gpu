FROM pytorch/pytorch:2.7.0-cuda12.8-cudnn9-runtime
ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /app
 
# ----------------------------
# System dependencies
# ----------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 \
    python3.11-dev \
    python3.11-venv \
    python3-pip \
    git \
    curl \
    build-essential \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
 
# ----------------------------
# Install uv (fast Python package manager)
# ----------------------------
RUN pip install --no-cache-dir uv
 
# ----------------------------
# Environment variables
# ----------------------------
ENV PYTHONUNBUFFERED=1 \
    PIP_DEFAULT_TIMEOUT=100 \
    PIP_RETRIES=5 \
    UV_SYSTEM_PYTHON=1 \
    UV_NO_CACHE=1
 
# ----------------------------
# BƯỚC 1: Copy dependency files
# ----------------------------
COPY pyproject.toml poetry.lock* README.md ./
 
# ----------------------------
# BƯỚC 2: Install dependencies với uv (cài trực tiếp để đảm bảo đầy đủ)
# ----------------------------
RUN uv pip install \
        python-dotenv pandas imbalanced-learn pydantic scikit-learn seaborn \
        dataclasses-json bandit joblib mlxtend xgboost tenacity pyarrow \
        litellm statsmodels hypothesis "numpy<2.0.0" black jinja2 platformdirs \
        "ray>=2.9.0" rich smolagents deprecated python-multipart psycopg2-binary \
        featuretools sqlalchemy pytorch-frame pooch duckdb scipy \
        fastapi "uvicorn[standard]" websockets langgraph langchain langchain-openai langchain-google-genai angchain-anthropic
 
# ----------------------------
# BƯỚC 3: Cài torchvision, torchaudio (torch đã có sẵn từ base image)
# ----------------------------
RUN uv pip install torchvision torchaudio
 
# ----------------------------
# BƯỚC 4: PyTorch Geometric dependencies (dùng pip vì PyG wheel index)
# Theo hướng dẫn chính thức: https://pytorch-geometric.readthedocs.io
# ----------------------------
RUN pip install pyg_lib torch_scatter torch_sparse torch_cluster torch_spline_conv \
    -f https://data.pyg.org/whl/torch-2.7.0+cu128.html
 
# ----------------------------
# BƯỚC 5: torch-geometric
# ----------------------------
RUN uv pip install torch-geometric torch-frame

# ----------------------------
# BƯỚC 6: sentence-transformers (for text embeddings in GNN training)
# ----------------------------
RUN uv pip install sentence-transformers

# ----------------------------
# BƯỚC 7: MLflow
# ----------------------------
RUN uv pip install "mlflow>=2.14.0,<3.0.0"
 
# ----------------------------
# Source code
# ----------------------------
COPY . .
 
# ----------------------------
# Sanity check (build-time - GPU not available during build)
# ----------------------------
RUN python - <<EOF
import torch
print("Torch:", torch.__version__)
print("Note: CUDA will be available at runtime, not during build")
import torch_geometric
print("PyG OK")
import sentence_transformers
print("sentence-transformers:", sentence_transformers.__version__)
import mlflow
print("MLflow:", mlflow.__version__)
from plexe import Model, PlexeOrchestrator
print("plexe import OK")
from plexe.langgraph import EDAAgent, ConversationalAgent
print("LangGraph agents OK")
EOF
 
CMD ["python", "-m", "uvicorn", "plexe.server:app", "--host", "0.0.0.0", "--port", "8100", "--reload", "--reload-dir", "plexe"]